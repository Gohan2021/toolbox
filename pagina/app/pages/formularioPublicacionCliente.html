<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Publicar necesidad - TOOLBOX</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-4">Publicar nueva necesidad</h2>
    <form id="formPublicarNecesidad" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Nombre completo</label>
            <input type="text" class="form-control" id="nombreCliente" required>
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Tel√©fono</label>
            <input type="text" class="form-control" id="telefonoCliente" required>
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Correo electr√≥nico</label>
            <input type="email" class="form-control" id="emailCliente" required>
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Zona o Localidad</label>
            <input type="text" class="form-control" id="zona" required>
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Horario de contacto</label>
            <input type="text" class="form-control" id="horarioContacto">
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Especialidad requerida</label>
            <select class="form-select" id="especialidadRequerida" required>
              <option selected disabled value="">Selecciona...</option>
              <!-- Puedes agregar m√°s -->
            </select>
          </div>
      
          <div class="col-12 mb-3">
            <label class="form-label">Descripci√≥n del servicio requerido</label>
            <textarea class="form-control" id="descripcion" rows="4" required></textarea>
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Presupuesto estimado</label>
            <input type="number" class="form-control" id="presupuesto" min="0">
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Fecha tentativa del servicio</label>
            <input type="date" class="form-control" id="fechaTentativa">
          </div>
      
          <div class="col-md-6 mb-3">
            <label class="form-label">Nivel de urgencia</label>
            <select class="form-select" id="urgencia">
              <option value="Baja">Baja</option>
              <option value="Media" selected>Media</option>
              <option value="Alta">Alta</option>
            </select>
          </div>
      
          <div class="mb-3">
            <label class="form-label">Subir im√°genes (Max. 5)</label>
            <div id="imageInputs" class="row g-2"></div>
          </div>   
      
          <div class="col-12 mb-3">
            <label class="form-label">Video descriptivo opcional (Max. 30 MB) </label>
            <input type="file" class="form-control" id="video" accept="video/*">
          </div>
      
          <div class="col-12 text-center">
            <button type="submit" class="btn btn-warning w-50">Publicar Solicitud</button>
          </div>
        </div>
      </form>
      
  </div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
  // üëâ Inicializar variables
  const maxImagenes = 5;
  const imageInputsContainer = document.getElementById("imageInputs");
  const selectEspecialidad = document.getElementById("especialidadRequerida");
  const servicios = [
    "Plomer√≠a",
    "Electricidad",
    "Carpinter√≠a",
    "Enchape y acabados",
    "Estructuras Met√°licas",
    "Pintura y acabados",
    "Cerrajer√≠a",
    "Refrigeraci√≥n y aire acondicionado",
    "Jardiner√≠a y paisajismo",
    "Obras Civiles"
  ];

  // üëâ Funci√≥n para agregar inputs de imagen
  function agregarInputImagen(index) {
    const inputGroup = document.createElement("div");
    inputGroup.classList.add("col-4", "text-center");

    const inputId = `input-${index}`;
    const previewId = `preview-${index}`;

    inputGroup.innerHTML = `
      <input type="file" accept="image/*" class="d-none" name="imagenes" id="${inputId}" onchange="mostrarPreview(this, '${previewId}')">
      <label for="${inputId}">
        <div class="image-preview border border-secondary rounded p-2" id="${previewId}" style="height: 100px; display: flex; align-items: center; justify-content: center;">
          <span class="plus-icon" style="font-size: 2rem; color: gray;">+</span>
        </div>
      </label>
    `;

    imageInputsContainer.appendChild(inputGroup);
  }

  // üëâ Inicializar 5 inputs de imagen
  for (let i = 0; i < maxImagenes; i++) {
    agregarInputImagen(i);
  }

  // üëâ Funci√≥n global para mostrar la preview de imagen
  window.mostrarPreview = function(input, previewId) {
    const preview = document.getElementById(previewId);

    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="width: 100%; height: 100%; object-fit: cover;">`;
      };
      reader.readAsDataURL(input.files[0]);
    }
  };

  // üëâ Cargar opciones del select de especialidad
  servicios.forEach(servicio => {
    const option = document.createElement("option");
    option.value = servicio;
    option.textContent = servicio;
    selectEspecialidad.appendChild(option);
  });

  // üëâ Autocompletar datos del cliente si est√° autenticado
  try {
    const response = await fetch("/api/cliente/perfil", {
      method: "GET",
      credentials: "include"
    });

    if (response.ok) {
      const data = await response.json();
      const cliente = data.cliente;

      if (cliente) {
        document.getElementById("nombreCliente").value = `${cliente.nombre} ${cliente.apellido}`;
        document.getElementById("emailCliente").value = cliente.email;
        document.getElementById("telefonoCliente").value = cliente.telefono;
      }
    } else {
      console.warn("Cliente no autenticado, no se autocompletar√°n los datos.");
    }
  } catch (error) {
    console.error("‚ùå Error al cargar perfil del cliente:", error);
  }

  // üëâ Manejar env√≠o del formulario
  document.getElementById("formPublicarNecesidad").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;

    if (!form.checkValidity()) {
      form.classList.add("was-validated");
      return;
    }

    const formData = new FormData();
    formData.append("nombre_cliente", document.getElementById("nombreCliente").value.trim());
    formData.append("telefono_cliente", document.getElementById("telefonoCliente").value.trim());
    formData.append("email_cliente", document.getElementById("emailCliente").value.trim());
    formData.append("zona", document.getElementById("zona").value.trim());
    formData.append("horario_contacto", document.getElementById("horarioContacto").value.trim());
    formData.append("especialidad_requerida", document.getElementById("especialidadRequerida").value);
    formData.append("descripcion", document.getElementById("descripcion").value.trim());
    formData.append("presupuesto", document.getElementById("presupuesto").value);
    formData.append("fecha_tentativa", document.getElementById("fechaTentativa").value);
    formData.append("urgencia", document.getElementById("urgencia").value);

    const video = document.getElementById("video").files[0];
    if (video) {
      formData.append("video", video);
    }

    try {
      const response = await fetch("http://localhost:4000/api/cliente/publicar-necesidad", {
        method: "POST",
        body: formData,
        credentials: "include"
      });

      const data = await response.json();

      if (response.ok) {
        alert("‚úÖ Solicitud publicada exitosamente");
        form.reset();
        form.classList.remove("was-validated");
      } else {
        alert(`‚ùå Error: ${data.message}`);
      }
    } catch (error) {
      console.error("‚ùå Error en la publicaci√≥n:", error);
      alert("Error de conexi√≥n al publicar.");
    }
  });
});

</script>

</body>
</html>
